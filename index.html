<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wasteland Drifter Online</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --bg: #0d0d0d;
            --term: #33ff00; /* Terminal Green */
            --alert: #ff3333;
            --warn: #ffcc00;
            --panel: #1a1a1a;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            color: var(--term);
            font-family: 'VT323', monospace;
            font-size: 20px;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- SCANLINE OVERLAY --- */
        body::after {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* --- LAYOUT --- */
        .top-bar {
            padding: 10px;
            border-bottom: 2px solid var(--term);
            display: flex;
            justify-content: space-between;
            background: #000;
            z-index: 10;
        }

        .main-view {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 80px; /* Space for nav */
        }

        /* --- CARDS --- */
        .card {
            border: 1px solid var(--term);
            background: #050505;
            padding: 10px;
            box-shadow: 0 0 5px rgba(51, 255, 0, 0.2);
        }
        .card h3 { margin: 0 0 10px 0; border-bottom: 1px dashed var(--term); font-size: 22px; }

        /* --- CHAT SYSTEM --- */
        #chat-box {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 5px;
            margin-bottom: 5px;
            font-size: 16px;
            background: #000;
        }
        .chat-msg { margin-bottom: 4px; word-wrap: break-word; }
        .chat-name { color: var(--warn); font-weight: bold; }
        .chat-input-row { display: flex; gap: 5px; }
        #msg-input { 
            flex-grow: 1; background: #000; color: var(--term); 
            border: 1px solid var(--term); font-family: inherit; padding: 5px; 
        }

        /* --- WORLD BOSS --- */
        .boss-bar-container {
            width: 100%; height: 20px; border: 1px solid var(--alert); 
            background: #330000; margin-bottom: 5px;
        }
        .boss-fill {
            height: 100%; background: var(--alert); width: 100%;
            transition: width 0.5s;
        }

        /* --- CONTROLS --- */
        .btn {
            background: #000; color: var(--term); border: 1px solid var(--term);
            padding: 10px; font-family: inherit; font-size: 18px; cursor: pointer;
            text-transform: uppercase; width: 100%;
        }
        .btn:active { background: var(--term); color: #000; }
        .btn:disabled { opacity: 0.5; border-color: #555; color: #555; }

        .nav {
            position: fixed; bottom: 0; width: 100%;
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            background: #000; border-top: 2px solid var(--term);
            z-index: 100;
        }
        .nav-btn {
            background: #000; color: #555; border: none; border-right: 1px solid #333;
            padding: 15px; font-family: inherit; font-size: 18px; cursor: pointer;
        }
        .nav-btn.active { color: var(--term); background: #0a0a0a; }

        /* SCREENS */
        .screen { display: none; }
        .screen.active { display: block; }
        
        .log-entry { font-size: 16px; margin-bottom: 5px; }
        .bad { color: var(--alert); }
        .good { color: var(--warn); }

    </style>
</head>
<body>

    <div class="top-bar">
        <span>HP: <span id="hp">100</span></span>
        <span>SCRAP: <span id="scrap">0</span></span>
    </div>

    <div id="tab-explore" class="main-view screen active">
        <div class="card" id="log-box" style="height: 200px; overflow-y: auto; margin-bottom: 10px;">
            <div class="log-entry">System Online.</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn" onclick="scavenge()">SCAVENGE</button>
            <button class="btn" onclick="rest()">REST</button>
        </div>

        <div class="card" style="margin-top: 20px; border-color: var(--alert);">
            <h3 style="color: var(--alert);">âš  GLOBAL EVENT: MUTANT TITAN</h3>
            <div class="boss-bar-container">
                <div id="boss-hp-bar" class="boss-fill"></div>
            </div>
            <div style="text-align: center; font-size: 16px; margin-bottom: 5px;">
                HP: <span id="boss-hp-text">Loading...</span> / 1000000
            </div>
            <button class="btn" style="border-color: var(--alert); color: var(--alert);" onclick="attackBoss()">ATTACK TITAN (Cost: 10 HP)</button>
            <div style="font-size: 14px; color: #777; text-align: center; margin-top: 5px;">
                All players damage this boss together.
            </div>
        </div>
    </div>

    <div id="tab-radio" class="main-view screen">
        <div class="card">
            <h3>ðŸ“¡ WASTELAND FREQUENCY</h3>
            <div id="chat-box">
                <div class="chat-msg" style="color:#777">Connecting to secure channel...</div>
            </div>
            <div class="chat-input-row">
                <input type="text" id="username" placeholder="Name" style="width: 60px; background:#000; color:var(--warn); border:1px solid var(--term); font-family:inherit; padding:5px;">
                <input type="text" id="msg-input" placeholder="Broadcast message...">
                <button class="btn" style="width: auto;" onclick="sendMessage()">SEND</button>
            </div>
        </div>
        <div style="padding: 10px; font-size: 14px; color: #555;">
            * This is a public frequency. All Drifters can see this.
        </div>
    </div>

    <div id="tab-profile" class="main-view screen">
        <div class="card">
            <h3>SURVIVOR STATUS</h3>
            <p>Days Survived: <span id="days">1</span></p>
            <p>Food: <span id="food">0</span></p>
            <p>Meds: <span id="meds">0</span></p>
        </div>
        <div class="card" style="margin-top: 10px;">
            <h3>SETTINGS</h3>
            <button class="btn" onclick="resetGame()">RESET DATA</button>
            <div style="margin-top: 10px; text-align: center;">
                <a href="https://ko-fi.com/" target="_blank" style="color: var(--warn);">Support the Dev</a>
            </div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="setTab('explore', this)">EXPLORE</button>
        <button class="nav-btn" onclick="setTab('radio', this)">RADIO</button>
        <button class="nav-btn" onclick="setTab('profile', this)">PROFILE</button>
    </div>

    <script>
        // --- GUN.JS MULTIPLAYER SETUP ---
        // We use public relay peers. These are free community servers.
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
        
        // Chat Node
        const chatNode = gun.get('wasteland-drifter-chat-v1');
        // Boss Node
        const bossNode = gun.get('wasteland-boss-v1');

        // --- LOCAL GAME STATE ---
        let state = {
            hp: 100, maxHp: 100, scrap: 0, food: 2, meds: 1, days: 1
        };

        // --- INIT ---
        window.onload = function() {
            if(localStorage.getItem('wd_online_save')) {
                state = JSON.parse(localStorage.getItem('wd_online_save'));
            }
            updateUI();
            
            // Listen for Chat
            chatNode.map().once((data, id) => {
                if(data && data.msg && data.time > Date.now() - 3600000) { // Only last 1 hour
                    addChatToUI(data.name, data.msg);
                }
            });

            // Listen for Boss HP
            bossNode.get('hp').on((hp) => {
                if(hp === undefined || hp === null) hp = 1000000;
                updateBossUI(hp);
            });
        };

        // --- CORE GAMEPLAY ---
        function scavenge() {
            if(state.hp <= 0) return;
            state.days++;
            let roll = Math.random();
            if(roll < 0.3) {
                let dmg = Math.floor(Math.random() * 10) + 5;
                state.hp -= dmg;
                log(`Attacked by Rat! Took ${dmg} dmg.`, "bad");
            } else {
                let find = Math.random();
                if(find < 0.5) { state.scrap += Math.floor(Math.random()*5)+1; log("Found Scrap."); }
                else if(find < 0.8) { state.food++; log("Found Food.", "good"); }
                else { state.meds++; log("Found Meds!", "good"); }
            }
            checkDeath();
            updateUI();
        }

        function rest() {
            if(state.hp <= 0) return;
            state.hp = Math.min(state.hp + 10, state.maxHp);
            log("Rested. +10 HP.");
            updateUI();
        }

        // --- MULTIPLAYER ACTIONS ---
        
        function sendMessage() {
            const name = document.getElementById('username').value || "Drifter";
            const msg = document.getElementById('msg-input').value;
            if(!msg) return;

            // Send to GUN network
            chatNode.set({
                name: name,
                msg: msg,
                time: Date.now()
            });

            document.getElementById('msg-input').value = "";
        }

        function addChatToUI(name, msg) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = 'chat-msg';
            div.innerHTML = `<span class="chat-name">[${name}]:</span> ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function attackBoss() {
            if(state.hp <= 10) { log("Too weak to fight Titan!", "bad"); return; }
            state.hp -= 10;
            updateUI();

            // Transaction to lower Global HP
            // Note: In a real app, we need backend validation. 
            // For this simple version, we trust the client (optimistic).
            bossNode.get('hp').once((currentHp) => {
                let newHp = (currentHp || 1000000) - 100; // Deal 100 damage
                if(newHp < 0) newHp = 1000000; // Reset if dead (Respawn)
                bossNode.get('hp').put(newHp);
                
                log(`You hit the Titan! Global HP: ${newHp}`, "good");
            });
        }

        function updateBossUI(hp) {
            document.getElementById('boss-hp-text').innerText = hp;
            let pct = (hp / 1000000) * 100;
            document.getElementById('boss-hp-bar').style.width = pct + "%";
        }

        // --- UTILS ---
        function checkDeath() {
            if(state.hp <= 0) {
                state.hp = 0;
                log("YOU DIED.", "bad");
                alert("You have died. Reload to restart.");
                state = { hp: 100, maxHp: 100, scrap: 0, food: 0, meds: 0, days: 1 };
            }
        }

        function updateUI() {
            document.getElementById('hp').innerText = state.hp;
            document.getElementById('scrap').innerText = state.scrap;
            document.getElementById('food').innerText = state.food;
            document.getElementById('meds').innerText = state.meds;
            document.getElementById('days').innerText = state.days;
            localStorage.setItem('wd_online_save', JSON.stringify(state));
        }

        function log(msg, type='') {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = `> ${msg}`;
            box.prepend(div);
        }

        function setTab(id, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function resetGame() {
            localStorage.removeItem('wd_online_save');
            location.reload();
        }
    </script>
</body>
</html>
