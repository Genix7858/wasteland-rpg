<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wasteland Drifter Online (Stable)</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --bg: #0d0d0d;
            --term: #33ff00;
            --alert: #ff3333;
            --warn: #ffcc00;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            color: var(--term);
            font-family: 'VT323', monospace;
            font-size: 20px;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- UI STYLES --- */
        .top-bar {
            padding: 10px;
            border-bottom: 2px solid var(--term);
            display: flex;
            justify-content: space-between;
            background: #000;
            z-index: 10;
        }

        .main-view {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            border: 1px solid var(--term);
            background: #050505;
            padding: 10px;
            box-shadow: 0 0 5px rgba(51, 255, 0, 0.2);
            position: relative;
        }
        .card h3 { margin: 0 0 10px 0; border-bottom: 1px dashed var(--term); font-size: 22px; }

        /* --- CHAT --- */
        #chat-box {
            height: 250px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 5px;
            margin-bottom: 5px;
            font-size: 16px;
            background: #000;
        }
        .chat-msg { margin-bottom: 4px; word-wrap: break-word; border-bottom: 1px dotted #222; }
        .chat-name { color: var(--warn); font-weight: bold; }
        .chat-time { font-size: 12px; color: #555; float: right; }
        
        .chat-input-row { display: flex; gap: 5px; }
        input { 
            background: #000; color: var(--term); border: 1px solid var(--term); 
            font-family: inherit; padding: 10px; font-size: 16px;
        }

        /* --- BOSS BAR --- */
        .boss-bar-container {
            width: 100%; height: 25px; border: 2px solid var(--alert); 
            background: #330000; margin-bottom: 5px; position: relative;
        }
        .boss-fill {
            height: 100%; background: var(--alert); width: 100%;
            transition: width 0.3s;
        }

        /* --- CONTROLS --- */
        .btn {
            background: #000; color: var(--term); border: 1px solid var(--term);
            padding: 15px; font-family: inherit; font-size: 20px; cursor: pointer;
            text-transform: uppercase; width: 100%;
        }
        .btn:active { background: var(--term); color: #000; }

        .nav {
            position: fixed; bottom: 0; width: 100%;
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            background: #000; border-top: 2px solid var(--term);
        }
        .nav-btn {
            background: #000; color: #555; border: none; border-right: 1px solid #333;
            padding: 15px; font-family: inherit; font-size: 18px; cursor: pointer;
        }
        .nav-btn.active { color: var(--term); background: #0a0a0a; border-top: 2px solid var(--term); }

        .status-dot {
            display: inline-block; width: 10px; height: 10px; border-radius: 50%;
            background: #555; margin-right: 5px;
        }
        .online { background: #00ff00; box-shadow: 0 0 5px #00ff00; }

        /* SCREENS */
        .screen { display: none; }
        .screen.active { display: block; }
    </style>
</head>
<body>

    <div class="top-bar">
        <span>HP: <span id="hp">100</span></span>
        <span>SCRAP: <span id="scrap">0</span></span>
    </div>

    <div id="tab-explore" class="main-view screen active">
        <div class="card" id="log-box" style="height: 150px; overflow-y: auto;">
            <div>> System Loaded.</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn" onclick="scavenge()">SCAVENGE</button>
            <button class="btn" onclick="rest()">REST</button>
        </div>

        <div class="card" style="margin-top: 20px; border-color: var(--alert);">
            <h3 style="color: var(--alert);">â˜  GLOBAL BOSS</h3>
            <div class="boss-bar-container">
                <div id="boss-hp-bar" class="boss-fill"></div>
            </div>
            <div style="text-align: center; font-size: 18px; margin-bottom: 10px;">
                HP: <span id="boss-hp-text">Connecting...</span>
            </div>
            <button class="btn" style="border-color: var(--alert); color: var(--alert);" onclick="attackBoss()">ATTACK (10 HP)</button>
        </div>
    </div>

    <div id="tab-radio" class="main-view screen">
        <div class="card">
            <h3>
                <span id="status-light" class="status-dot"></span> 
                FREQUENCY <span id="status-text" style="font-size:12px; float:right;">OFFLINE</span>
            </h3>
            <div id="chat-box"></div>
            
            <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 5px;">
                <input type="text" id="username" placeholder="Codename" style="border-color: var(--warn); color: var(--warn);">
                <div class="chat-input-row">
                    <input type="text" id="msg-input" placeholder="Message..." style="flex-grow:1;">
                    <button class="btn" style="width: auto;" onclick="sendMessage()">TX</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-profile" class="main-view screen">
        <div class="card">
            <h3>STATUS</h3>
            <p>Days Survived: <span id="days">1</span></p>
            <p>Inventory: <span id="inv">Empty</span></p>
        </div>
        <div class="card" style="margin-top:10px;">
            <h3>DEBUG</h3>
            <button class="btn" onclick="location.reload()">RECONNECT</button>
            <p style="font-size:12px; color:#555; margin-top:5px;">If chat stops working, click Reconnect.</p>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="setTab('explore', this)">EXPLORE</button>
        <button class="nav-btn" onclick="setTab('radio', this)">RADIO</button>
        <button class="nav-btn" onclick="setTab('profile', this)">PROFILE</button>
    </div>

    <script>
        // --- MULTIPLAYER SETUP (The Fix) ---
        // We now use a list of 3 peers. If one fails, others might work.
        const peers = [
            'https://gun-manhattan.herokuapp.com/gun',
            'https://gun-us.herokuapp.com/gun',
            'https://peer.wallie.io/gun'
        ];

        const gun = Gun({ peers: peers });
        
        // Specific Room Keys (Unique so they don't clash with others)
        const APP_KEY = 'wasteland_v8_stable_';
        const chatNode = gun.get(APP_KEY + 'chat');
        const bossNode = gun.get(APP_KEY + 'boss');

        // --- LOCAL STATE ---
        let state = { hp: 100, maxHp: 100, scrap: 0, days: 1, inv: [] };
        let isConnected = false;

        // --- INIT ---
        window.onload = function() {
            // Load Local Save
            if(localStorage.getItem('wd_stable_save')) {
                state = JSON.parse(localStorage.getItem('wd_stable_save'));
            }
            updateUI();

            // CHECK CONNECTION
            // We write a random value to see if it syncs
            log("Connecting to Global Frequency...");
            setTimeout(() => {
                if(!isConnected) {
                    document.getElementById('status-text').innerText = "WEAK SIGNAL";
                    log("Connection is slow. Be patient.");
                }
            }, 3000);
        };

        // --- NETWORKING EVENTS ---
        
        // 1. LISTEN FOR CHAT (Limit to last 10 messages visually)
        chatNode.map().once((data, id) => {
            if(!data || !data.msg) return;
            // Only show messages from last 24 hours to prevent lag
            if(data.time > Date.now() - 86400000) {
                // Mark connected if we receive data
                setConnected();
                addChat(data);
            }
        });

        // 2. LISTEN FOR BOSS
        bossNode.get('hp').on((hp) => {
            setConnected();
            if(hp === undefined || hp === null) hp = 500000;
            updateBoss(hp);
        });

        function setConnected() {
            if(isConnected) return;
            isConnected = true;
            document.getElementById('status-light').classList.add('online');
            document.getElementById('status-text').innerText = "ONLINE";
            log("Connected to Multiplayer Network.", "good");
        }

        // --- ACTIONS ---

        function sendMessage() {
            const name = document.getElementById('username').value || "Unknown";
            const msg = document.getElementById('msg-input').value;
            if(!msg) return;

            const messageData = {
                name: name,
                msg: msg,
                time: Date.now()
            };

            // Send to Gun
            chatNode.set(messageData);
            document.getElementById('msg-input').value = "";
        }

        function attackBoss() {
            if(state.hp <= 10) { log("Too weak!", "bad"); return; }
            state.hp -= 10;
            updateUI();

            // Optimistic update
            bossNode.get('hp').once((currentHp) => {
                let hp = currentHp || 500000;
                let newHp = hp - 100;
                if(newHp <= 0) {
                    newHp = 500000; // Reset boss
                    log("TITAN DEFEATED! IT RESPAWNS STRONGER!", "good");
                }
                bossNode.get('hp').put(newHp);
                log(`Attacked Titan! HP: ${newHp}`);
            });
        }

        // --- UI UPDATERS ---

        function addChat(data) {
            // Check if msg already exists (simple dedupe)
            const id = `msg-${data.time}`;
            if(document.getElementById(id)) return;

            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.id = id;
            div.className = 'chat-msg';
            
            // Format time
            const date = new Date(data.time);
            const timeStr = date.getHours() + ":" + (date.getMinutes()<10?'0':'') + date.getMinutes();

            div.innerHTML = `<span class="chat-name">${data.name}</span> <span class="chat-time">${timeStr}</span><br>${data.msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function updateBoss(hp) {
            document.getElementById('boss-hp-text').innerText = Math.floor(hp);
            let pct = (hp / 500000) * 100;
            document.getElementById('boss-hp-bar').style.width = pct + "%";
        }

        function scavenge() {
            if(state.hp<=0) return;
            state.days++;
            let r = Math.random();
            if(r < 0.3) {
                let dmg = Math.floor(Math.random()*10)+5;
                state.hp -= dmg;
                log(`Danger! Took ${dmg} damage.`, "bad");
            } else {
                state.scrap += Math.floor(Math.random()*5)+1;
                log("Found Scrap.");
            }
            updateUI();
        }

        function rest() {
            state.days++;
            state.hp = Math.min(state.hp+15, state.maxHp);
            log("Rested. HP restored.");
            updateUI();
        }

        function log(msg, type='') {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.style.color = type === 'bad' ? 'var(--alert)' : (type==='good'?'var(--warn)':'var(--term)');
            div.innerText = `> ${msg}`;
            box.prepend(div);
        }

        function updateUI() {
            if(state.hp <= 0) state.hp = 0;
            document.getElementById('hp').innerText = state.hp;
            document.getElementById('scrap').innerText = state.scrap;
            document.getElementById('days').innerText = state.days;
            localStorage.setItem('wd_stable_save', JSON.stringify(state));
        }

        function setTab(id, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
</body>
</html>
